<!DOCTYPE html>
<html lang="en">
  <head>
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://assets.lemonsqueezy.com; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self'; connect-src 'self' https://formspree.io https://*.lemonsqueezy.com;">
    <meta name="robots" content="noindex, nofollow"> <meta charset="UTF-8" />
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport" />
    
    <title>Asset Retrieval | Kynar Operations</title>
    
    <link href="styles.css" rel="stylesheet" />
    
    <script src="https://cdn.jsdelivr.net/gh/studio-freight/lenis@1.0.29/bundled/lenis.min.js"></script>
    <script type="module" src="ui-core.js"></script>

    <style>
      /* Retrieval Animation */
      .vault-icon { 
        font-size: 4rem; 
        margin-bottom: 25px; 
        display: inline-block; 
        transition: transform 0.5s ease;
      }
      .anim-float { animation: float 3s ease-in-out infinite; opacity: 0.5; }
      .anim-lock { transform: scale(1.1); opacity: 1; }
      
      .verifying { 
        border-style: dashed !important; 
        animation: pulse-border 2s infinite; 
        background: rgba(0,0,0,0.02);
      }
      
      @keyframes pulse-border {
        0% { border-color: rgba(15, 61, 48, 0.1); }
        50% { border-color: rgba(197, 160, 89, 0.6); }
        100% { border-color: rgba(15, 61, 48, 0.1); }
      }
    </style>
  </head>

  <body>

    <header class="app-header" id="global-header"></header>

    <main class="container flex-col flex-center text-center" style="min-height: 80vh;">
      <div class="reveal-up" style="max-width: 500px; width: 100%;">
        
        <div class="vault-icon anim-float" id="status-icon">‚è≥</div>

        <span id="security-label" class="text-accent text-upper text-bold text-xs" style="letter-spacing: 0.25em; display: block; margin-bottom: 20px;">
          Authenticating...
        </span>

        <h1 id="claim-title" class="heading-lg">
          Decrypting <br /><span class="text-faded">Protocol.</span>
        </h1>

        <p id="download-meta" class="text-sm mx-auto" style="margin-bottom: 45px; max-width: 40ch;">
          Verifying security certificates and generating unique access token for the requested asset.
        </p>

        <div id="action-cluster" class="flex-col gap-sm" style="opacity: 0; pointer-events: none; transition: opacity 0.5s ease; transform: translateY(10px);">
          <a class="btn btn--primary w-full" id="downloadBtn" href="#">
            Retrieve Asset
          </a>
          <a class="btn btn--ghost w-full" href="index.html">
            Return to Operations
          </a>
        </div>

        <div id="security-box" class="card verifying" style="margin-top: 50px; padding: 25px;">
           <p class="text-xs text-faded" id="security-text">
            üîí <strong>Security Protocol:</strong> Handshaking with secure server...
          </p>
        </div>

      </div>
    </main>

    <footer id="global-footer"></footer>
    
    <script type="module">
      import { vault } from './vault.js'; // Corrected Path

      document.addEventListener("DOMContentLoaded", () => {
        const params = new URLSearchParams(window.location.search);
        const productId = params.get("id");
        
        // TIMEOUT: Simulates the "System Check"
        setTimeout(() => {
            // Find product
            const product = vault.find(p => p.id === productId);
            
            // Fallback if ID is invalid
            const activeProduct = product || { title: "Initiation Kit", link: "#" };

            // 1. Update UI to "Success" State
            document.getElementById("security-label").textContent = "Access Granted";
            document.getElementById("security-label").style.color = "var(--color-success)";
            
            document.getElementById("claim-title").innerHTML = `Asset <br /><span class="text-faded">Decrypted.</span>`;
            
            document.getElementById("download-meta").innerHTML = `The <strong>${activeProduct.title}</strong> protocol is ready for transfer.`;
            
            // Icon Change
            const icon = document.getElementById("status-icon");
            icon.textContent = "üîì";
            icon.classList.remove("anim-float");
            icon.classList.add("anim-lock");
            
            // Security Box Update
            const box = document.getElementById("security-box");
            box.classList.remove('verifying');
            box.style.borderStyle = "solid";
            box.style.borderColor = "var(--color-accent)";
            document.getElementById("security-text").innerHTML = "üîí <strong>Link Verified:</strong> Connection secure. 24h validity.";

            // Reveal Buttons
            const actions = document.getElementById("action-cluster");
            actions.style.opacity = "1";
            actions.style.pointerEvents = "all";
            actions.style.transform = "translateY(0)";

            // Set Link
            const btn = document.getElementById("downloadBtn");
            // If product has a specific file, link to it. Otherwise, link to the external URL (e.g. LemonSqueezy)
            btn.href = activeProduct.link; 
            
            // Haptic Feedback
            if(navigator.vibrate) navigator.vibrate([40, 60]);

        }, 2000); // 2 Second "Loading" time
        
        // Initial Reveal
        setTimeout(() => document.querySelector('.reveal-up').classList.add('reveal-visible'), 100);
      });
    </script>

  </body>
</html>
