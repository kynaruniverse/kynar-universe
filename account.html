<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Account | KYNAR Universe</title>
    <meta name="description" content="Manage your KYNAR Universe profile and access your digital tools.">
    
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="icon" type="image/png" href="assets/favicon.png">

        <script type="module">
        import { auth, onAuthStateChanged } from "./firebase-config.js";
        // Auth check - logic handled in body to allow Skeleton UI
        onAuthStateChanged(auth, (user) => {
            if (!user) window.location.replace("index.html");
        });
    </script>

</head>

<body class="account-page">
    <div class="drawer-overlay" id="drawer-overlay" aria-hidden="true"></div>

    <div class="header-wrapper">
        <div data-include="components/header.html"></div>
    </div>

            <main class="main-content-container">
        
        <div id="account-skeleton" class="account-dashboard">
            <div class="skeleton-header skeleton"></div>
            <div class="skeleton-grid">
                <div class="skeleton-card skeleton" style="height: 120px;"></div>
                <div class="skeleton-card skeleton" style="height: 120px;"></div>
            </div>
            <div class="skeleton-list skeleton" style="height: 300px; margin-top: 20px;"></div>
        </div>

        <section id="account-real-content" class="account-nexus" style="display: none;">
            
            <header class="nexus-header">
                <div class="nexus-bg"></div> <div class="nexus-profile">
                    <div class="holo-avatar">
                        <span id="user-initial">K</span>
                        <div class="holo-ring"></div>
                    </div>
                    <div class="nexus-welcome">
                        <span class="nexus-label">Welcome back,</span>
                        <h1 id="welcome-name" class="nexus-name">Creator</h1>
                        <p id="user-meta" class="nexus-meta">Member since 2025</p>
                    </div>
                </div>

                <div class="nexus-actions">
                    <button id="open-settings" class="btn-glass-icon" title="Settings">
                        <i class="fa-solid fa-gear"></i>
                    </button>
                    <button id="account-sign-out" class="btn-glass-icon danger" title="Sign Out">
                        <i class="fa-solid fa-power-off"></i>
                    </button>
                </div>
            </header>

            <div class="command-grid">
                <div class="glass-stat">
                    <div class="stat-icon"><i class="fa-solid fa-box-open"></i></div>
                    <div class="stat-info">
                        <span id="owned-count" class="stat-value">0</span>
                        <span class="stat-title">Assets Owned</span>
                    </div>
                </div>

                <div class="glass-stat">
                    <div class="stat-icon"><i class="fa-regular fa-heart"></i></div>
                    <div class="stat-info">
                        <span id="wishlist-count" class="stat-value">0</span>
                        <span class="stat-title">Wishlist</span>
                    </div>
                </div>
            </div>

            <div class="digital-vault">
                <div class="vault-header">
                    <h2><i class="fa-solid fa-server"></i> Digital Vault</h2>
                    <a href="https://gumroad.com/library" target="_blank" class="vault-link">
                        Gumroad Library <i class="fa-solid fa-arrow-up-right-from-square"></i>
                    </a>
                </div>

                <div id="purchase-list" class="vault-grid">
                    <div class="vault-empty">
                        <i class="fa-solid fa-cloud"></i>
                        <p>Your vault is empty.</p>
                        <a href="marketplace.html" class="btn btn-primary btn-sm">Explore Marketplace</a>
                    </div>
                </div>
            </div>

        </section>
    </main>



    <div data-include="components/footer.html"></div>
    <div data-include="components/auth-modals.html"></div>
    
    <div class="auth-modal" id="settings-modal" aria-hidden="true">
        <div class="auth-modal-backdrop" id="settings-backdrop"></div>
        <div class="auth-modal-dialog">
            <button class="auth-modal-close" id="settings-close">âœ•</button>
            <h2 class="auth-modal-heading">Settings</h2>
            <form id="settings-form">
                <label class="auth-label">
                    <span>Update Display Name</span>
                    <input id="settings-display-name" type="text" maxlength="40">
                </label>
                <button type="submit" class="btn btn-primary btn-md btn-full-width">Save Changes</button>
                <p id="settings-message" class="auth-message"></p>
            </form>
        </div>
    </div>

    <script src="utilities.js"></script>
    <script src="loading-state.js"></script>
    <script src="script.js" defer></script>
    <script src="cart.js" defer></script>

    <script src="auth-ui.js" type="module"></script>

    <script type="module">
        import { auth, db, signOut, onAuthStateChanged } from "./firebase-config.js";
        // NOTE: Importing specific firestore functions here is fine for page-specific logic
        import { doc, getDoc, updateDoc } from "./firebase-config.js";


                // Main Logic Wrapper
        function initAccountLogic(user) {
            console.log("Initializing Account for:", user.displayName);

            const welcomeNameEl = document.getElementById('welcome-name');
            const initialEl = document.getElementById('user-initial');
            const welcomeMetaEl = document.getElementById('user-meta');

            // 1. Initial UI Set from Auth Data
            let nameToShow = user.displayName || "Friend"; 
            if (welcomeNameEl) welcomeNameEl.textContent = nameToShow;
            if (initialEl) initialEl.textContent = nameToShow.charAt(0).toUpperCase();

            // 2. Load Extra Data from Firestore
            // Use .then() to wait for data before hiding skeleton
            loadAccountData(user.uid).then(() => {
                // SWAP: Hide Skeleton -> Show Content
                const skeleton = document.getElementById('account-skeleton');
                const content = document.getElementById('account-real-content');
                
                if (skeleton) skeleton.style.display = 'none';
                if (content) {
                    content.style.display = 'block';
                    content.classList.add('reveal-on-scroll', 'is-visible'); // Add entry animation
                }
            });

            // 3. Settings Form Logic
            setupSettingsForm(user);
            
            // 4. Local Sign Out
            const localSignOut = document.getElementById('account-sign-out');
            if (localSignOut) {
                localSignOut.addEventListener('click', async (e) => {
                    e.preventDefault();
                    if(confirm('Sign out of your account?')) {
                        await signOut(auth);
                        window.location.href = "index.html";
                    }
                });
            }
        }


        async function loadAccountData(uid) {
            const ownedCountEl = document.getElementById('owned-count');
            const wishlistCountEl = document.getElementById('wishlist-count');
            const purchaseListEl = document.getElementById('purchase-list');
            const welcomeMetaEl = document.getElementById('user-meta');

            try {
                const userDoc = await getDoc(doc(db, "users", uid));
                if (userDoc.exists()) {
                    const data = userDoc.data();
                    
                    // Update Name if Firestore is more recent than Auth
                    if (data.displayName) {
                        const welcomeNameEl = document.getElementById('welcome-name');
                        if (welcomeNameEl) welcomeNameEl.textContent = data.displayName;
                        const initialEl = document.getElementById('user-initial');
                        if (initialEl) initialEl.textContent = data.displayName.charAt(0).toUpperCase();
                    }

                    // Update Meta
                    if (data.createdAt && welcomeMetaEl) {
                         const date = new Date(data.createdAt);
                         welcomeMetaEl.textContent = `Member since ${date.toLocaleDateString(undefined, {month: 'long', year: 'numeric'})}`;
                    }

                    // Update Counts
                    const purchases = data.purchases || [];
                    const wishlist = data.wishlist || [];
                    
                    if (ownedCountEl) ownedCountEl.textContent = purchases.length;
                    if (wishlistCountEl) wishlistCountEl.textContent = wishlist.length;

                                        // Update List (The Vault)
                    if (purchaseListEl) {
                        if (purchases.length > 0) {
                            const recent = purchases.slice(-5).reverse(); // Show last 5
                            purchaseListEl.innerHTML = recent.map(p => `
                                <div class="vault-item">
                                    <div class="v-info">
                                        <h4>${p.title}</h4>
                                        <div class="v-date">${new Date(p.purchaseDate).toLocaleDateString()}</div>
                                    </div>
                                    ${p.downloadUrl ? 
                                        `<a href="${p.downloadUrl}" target="_blank" class="btn btn-secondary btn-sm">
                                            <i class="fa-solid fa-download"></i> Access
                                        </a>` 
                                        : '<span style="font-size:11px; opacity:0.5;">Processing</span>'}
                                </div>
                            `).join('');
                        } else {
                            purchaseListEl.innerHTML = `
                                <div class="vault-empty">
                                    <i class="fa-solid fa-cloud"></i>
                                    <p>Your digital vault is empty.</p>
                                    <a href="marketplace.html" class="btn btn-primary btn-sm" style="margin-top:10px;">Explore the Universe</a>
                                </div>
                            `;
                        }
                    }

                }
            } catch (error) {
                console.error("Error loading profile:", error);
            }
        }

        function setupSettingsForm(user) {
            const settingsModal = document.getElementById('settings-modal');
            const openBtn = document.getElementById('open-settings');
            const closeBtn = document.getElementById('settings-close');
            const form = document.getElementById('settings-form');

            if (openBtn && settingsModal) {
                openBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    settingsModal.classList.add('is-open');
                    document.getElementById('settings-display-name').value = user.displayName || "";
                });

                // Close logic
                const close = () => settingsModal.classList.remove('is-open');
                closeBtn.addEventListener('click', close);
                document.getElementById('settings-backdrop').addEventListener('click', close);

                form.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const newName = document.getElementById('settings-display-name').value.trim();
                    if (!newName) return;

                    try {
                        // Update Firestore
                        await updateDoc(doc(db, "users", user.uid), { displayName: newName });
                        // Simple reload to reflect changes
                        window.location.reload();
                    } catch (err) {
                        console.error(err);
                        alert("Failed to update name");
                    }
                });
            }
        }

        // Initialize
        onAuthStateChanged(auth, (user) => {
            if (user) initAccountLogic(user);
        });
    </script>
</body>
</html>
